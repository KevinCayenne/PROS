---
title: "PROS project R Notebook by ZY"
output: html_notebook
---
<br/>

+ #### R initialization:
```{r "setup"}
library(knitr)
opts_knit$set(root.dir = "C:/Users/acer/Desktop/PROS/Data/fMRI_PilotData")

library(ggplot2)
library(ggpubr)
library(gtools)
library(gridExtra)
```
<br/>

+ #### Use `list.files()` function to list all file names into File.list variable:

```{r}
File.list <- mixedsort(list.files("behaviorD"))
```
<br/>

+ #### Use `paste()` function to biuld the variables inside the path:
```{r}
combined = paste("./behaviorD/", File.list, sep="")
```
<br/>

+ #### Count the length inside the file path (how many files in the directory):
```{r}
leng = length(combined)
```
<br/>

+ #### There are 6 files for each subject, divided by six for the number of subjects:
```{r}
Subject.number =leng/6
```
<br/>

+ #### Read the contents of the first file (you don't neet to read only the first file, but for simplicity, eliminating the time to define data.frame:

```{r}
merge.data <- read.csv(file = combined[ 1], header=T, sep=",")
```
<br/>

+ #### Complete data reading:
```{r}
for (i in 2:leng){
  new.data = read.csv(file = combined[ i], header=T, sep=",")
  merge.data = rbind(merge.data,new.data)
}

behavior.df <- data.frame(merge.data)
```
<br/>

```{r, include=FALSE}
############################## Adding columns ########################################

youngnum <- round(table(behavior.df$GroupN)[1]/64)
oldnum <- round(table(behavior.df$GroupN)[2]/64)
#calculate the subjects number in groups 

ncolbehavior.df <- ncol(behavior.df) #計算column number

for (i in c(1:nrow(behavior.df))){
  behavior.df[i, ncolbehavior.df+1] <- behavior.df[i, 12] - behavior.df[i, 11] # MDRT  - MDFirstP = 給錢情境的反應時間 ( 12 - 11 ) 
  behavior.df[i, ncolbehavior.df+2] <- behavior.df[i, 15] - behavior.df[i, 14] # EmoRT - EFirstP = 情緒反應的反應時間 ( 15 - 14 )
  behavior.df[i, ncolbehavior.df+3] <- behavior.df[i, 27] - behavior.df[i, 22] # TrialEnd - fixOnsettime  = ITI duration = ITI ( 27 - 22 )
  behavior.df[i, ncolbehavior.df+4] <- behavior.df[i, 24] - behavior.df[i, 23] # ISIstart - MDOnsettime = 給錢情境的duraiton ( 24 - 23 )
  behavior.df[i, ncolbehavior.df+5] <- behavior.df[i, 25] - behavior.df[i, 24] # EmoOnsettime  - ISIstart = ISI duration = ISI ( 25 - 24 )
  behavior.df[i, ncolbehavior.df+6] <- behavior.df[i, 26] - behavior.df[i, 25] # EmoEndtime - EmoOnsettime = 情緒選擇的duration ( 26 - 25 )
  behavior.df[i, ncolbehavior.df+7] <- behavior.df[i, 27] - behavior.df[i,  5] # TrialEnd - TriggerS = 從Trigger開始到當前Trial結束的時間 ( 27 - 5 )
  
  if (i >= 2){ 
    behavior.df[i, ncolbehavior.df+8] <- behavior.df[i, ncolbehavior.df+7] - behavior.df[(i-1), ncolbehavior.df+7] #一個Trial的總時間
  }
}

for (i in c(1:nrow(behavior.df))){
  behavior.df[i, ncolbehavior.df+9] <- behavior.df[i, 21] - behavior.df[i, 5] #LongFixation總時間( 21 -5 )
  behavior.df[i, ncolbehavior.df+10] <- behavior.df[i, 19] + behavior.df[i, 20] + 24000 #default duartion per trial =  behavior.df[i, ncolbehavior.df+8]
  }
behavior.df[1, ncolbehavior.df+8] <- behavior.df[1, ncolbehavior.df+7] - behavior.df[1, ncolbehavior.df+9] #第一個Trial的總時間
colnames(behavior.df)[(ncolbehavior.df+1):(ncolbehavior.df+10)] <- c("MoneyD_RT", "EmoD_RT", "ITI_D", "MoneyD", "ISI_D","EmoD","DTriggerOnset","TrialD","LongD","DefaultT")
# adding tags

behavior.con <- behavior.df
behavior.con$SIT <- NULL 
behavior.con$EmoRESP <- NULL
```


```{r, include=FALSE}
############################## ALL plotting MD + Emo ##########################################

## Total MD plot #####

ALL_Money <- as.vector(tapply(behavior.df$giveM, list(behavior.df$SITtag, behavior.df$GroupN), mean))
ALL_Money <- replace(ALL_Money, c(2,3), ALL_Money[c(3,2)])
ALL_Money <- replace(ALL_Money, c(2,5), ALL_Money[c(5,2)])
ALL_Money <- replace(ALL_Money, c(4,6), ALL_Money[c(6,4)])
ALL_Money <- replace(ALL_Money, c(6,7), ALL_Money[c(7,6)])

ALL_money.sd <- as.vector(tapply(behavior.df$giveM, list(behavior.df$SITtag, behavior.df$GroupN), sd)/sqrt(Subject.number)) 

ALL_Money_Y.se <- (apply(tapply(behavior.df$giveM, list(behavior.df$SITtag, behavior.df$SubjectN, behavior.df$GroupN), mean)[,,1], 1, sd, na.rm = T))/sqrt(youngnum)

ALL_Money_O.se <- (apply(tapply(behavior.df$giveM, list(behavior.df$SITtag, behavior.df$SubjectN, behavior.df$GroupN), mean)[,,2], 1, sd, na.rm = T))/sqrt(oldnum)

ALL_Money.se <- c(ALL_Money_Y.se, ALL_Money_O.se)

ALL_Money.se <- replace(ALL_Money.se, c(2,3), ALL_Money.se[c(3,2)])
ALL_Money.se <- replace(ALL_Money.se, c(2,5), ALL_Money.se[c(5,2)])
ALL_Money.se <- replace(ALL_Money.se, c(4,6), ALL_Money.se[c(6,4)])
ALL_Money.se <- replace(ALL_Money.se, c(6,7), ALL_Money.se[c(7,6)])

x <- as.factor(c(rep("prosocial",2),rep("purchase",2),rep("neutral",2),rep("Uncommon",2)))
Group <- as.factor(rep(c('Young','Old'),times = 4)) 
x <- factor(x, levels = levels(x))
levels(x) <- list(prosocial = "prosocial", purchase = "purchase",neutral = "neutral", Uncommon = "Uncommon")
levels(Group) <- list(Young = "Young", Old = "Old")
Group <- factor(Group , levels = c('Old','Young'), order = T)
title.name <- sprintf("Average of money givilang pilot_ALL(Old: %d, Young: %d)", oldnum, youngnum)
```

```{r, fig.align='center'}
total.MD.plot <- ggplot() +
        
                 geom_bar(mapping = aes(x = x, y = ALL_Money, fill = Group),
                          stat = 'identity', position = 'dodge', color="black") +
                      
                 labs(title = title.name, x = "Conditions", y = "Unit: dollars") +
                 ylim(c(0,300)) +
                      
                 theme(plot.title = element_text(hjust = 0.5),
                       title = element_text(size=15),
                       legend.text = element_text(size=15),
                       legend.title = element_text(size=15),
                       axis.text = element_text(size=13),
                       axis.title = element_text(size=13,face="bold")) +
                      
                 geom_text(mapping = aes(x = x, y = ALL_Money, group = Group),
                           size = 4, colour = 'black', vjust = -0.5, hjust = .5,
                           label=format(ALL_Money, digits=4),
                           position = position_dodge(.9)) +
                      
                 geom_errorbar(aes(x = x, ymin = ALL_Money, ymax = ALL_Money + ALL_Money.se, group = Group), width= .3,
                              position = position_dodge(.9))
total.MD.plot
```



